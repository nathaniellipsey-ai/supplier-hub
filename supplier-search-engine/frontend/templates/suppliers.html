{% extends 'base.html' %}

{% block title %}Suppliers - Supplier Search Engine{% endblock %}

{% block extra_styles %}
<style>
    .filters {
        display: flex;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .filter-input {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: transform 0.2s;
    }
    
    .btn:hover {
        transform: scale(1.05);
    }
    
    .suppliers-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .suppliers-table th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
    }
    
    .suppliers-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    .suppliers-table tr:hover {
        background: #f9f9f9;
    }
    
    .supplier-name {
        font-weight: 600;
        color: #667eea;
        cursor: pointer;
    }
    
    .supplier-name:hover {
        text-decoration: underline;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-verified {
        background: #d4edda;
        color: #155724;
    }
    
    .rating {
        color: #ffc107;
        font-weight: 600;
    }
    
    .pagination {
        display: flex;
        gap: 10px;
        margin-top: 30px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .pagination button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .pagination button:hover {
        background: #f5f5f5;
    }
    
    .pagination button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<h1>üè¢ Suppliers</h1>

<div class="filters">
    <input type="text" id="searchInput" class="filter-input" placeholder="Search suppliers by name...">
    <select id="categorySelect" class="filter-input">
        <option value="">All Categories</option>
    </select>
    <button class="btn" onclick="loadSuppliers()">Search</button>
</div>

<div id="loading" class="loading">Loading suppliers...</div>
<div id="content" style="display: none;">
    <div id="resultCount" style="margin: 10px 0; color: #666;"></div>
    
    <table class="suppliers-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Location</th>
                <th>Rating</th>
                <th>AI Score</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="suppliersBody"></tbody>
    </table>
    
    <div class="pagination" id="pagination"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentPage = 1;
    const itemsPerPage = 20;
    let allSuppliers = [];
    
    async function loadCategories() {
        try {
            const response = await fetch(API_BASE + '/api/categories');
            const data = await response.json();
            
            const select = document.getElementById('categorySelect');
            const options = Object.keys(data.categories)
                .map(cat => `<option value="${cat}">${cat}</option>`)
                .join('');
            select.innerHTML = '<option value="">All Categories</option>' + options;
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    async function loadSuppliers(page = 1) {
        try {
            currentPage = page;
            const skip = (page - 1) * itemsPerPage;
            const response = await fetch(API_BASE + `/api/suppliers?skip=${skip}&limit=${itemsPerPage}`);
            const data = await response.json();
            
            allSuppliers = data.suppliers || [];
            
            // Apply filters
            let filtered = allSuppliers;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categorySelect').value;
            
            if (searchTerm) {
                filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm));
            }
            if (selectedCategory) {
                filtered = filtered.filter(s => s.category === selectedCategory);
            }
            
            // Display results
            const tbody = document.getElementById('suppliersBody');
            tbody.innerHTML = filtered.map(supplier => `
                <tr onclick="viewSupplier(${supplier.id})" style="cursor: pointer;">
                    <td class="supplier-name">${supplier.name}</td>
                    <td>${supplier.category}</td>
                    <td>${supplier.location}</td>
                    <td class="rating">‚≠ê ${supplier.rating}</td>
                    <td>${supplier.aiScore}</td>
                    <td>
                        ${supplier.walmartVerified ? '<span class="badge badge-verified">‚úì Verified</span>' : ''}
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('resultCount').textContent = 
                `Showing ${filtered.length} of ${data.total} suppliers`;
            
            // Pagination
            const totalPages = Math.ceil(data.total / itemsPerPage);
            const paginationDiv = document.getElementById('pagination');
            let paginationHTML = '';
            
            if (page > 1) {
                paginationHTML += `<button onclick="loadSuppliers(${page - 1})">‚Üê Previous</button>`;
            }
            
            for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                paginationHTML += `<button class="${i === page ? 'active' : ''}" onclick="loadSuppliers(${i})">${i}</button>`;
            }
            
            if (page < totalPages) {
                paginationHTML += `<button onclick="loadSuppliers(${page + 1})">Next ‚Üí</button>`;
            }
            
            paginationDiv.innerHTML = paginationHTML;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        } catch (error) {
            console.error('Error loading suppliers:', error);
            document.getElementById('loading').innerHTML = 
                `<div class="error">Error loading suppliers. Make sure the backend API is running.</div>`;
        }
    }
    
    function viewSupplier(id) {
        // Store the supplier ID and navigate to detail page
        localStorage.setItem('selectedSupplierId', id);
        // For now, just show an alert
        alert(`Supplier #${id} selected. Full detail view coming soon!`);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        loadSuppliers();
    });
</script>
{% endblock %}
